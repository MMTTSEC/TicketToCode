@page "/login"
@inject NavigationManager nav
@inject HttpClient http

<PageTitle>Login/Register</PageTitle>

<!-- With Blazor Form Validation -->
<div id="login">
    <h1>Login</h1>
    <EditForm Model=@LoginForms OnValidSubmit="@LoginFormMethod">
        <input type="text" id="uname" name="uname" placeholder="Username" @bind-value="LoginForms.uname" required />
        <input type="password" id="upass" name="upass" placeholder="Password" @bind-value="LoginForms.upass" minlength="8" required />
        <button type="submit">Login</button>
    </EditForm>
</div>

<div id="register">
    <h1>Register</h1>
    <EditForm Model=@RegisterForms OnValidSubmit="@RegisterFormMethod">
        <input type="text" id="reguname" name="reguname" @bind-value="RegisterForms.username" placeholder="Username" required />
        <input type="password" id="regupass" style="@PasswordErrorStyle" name="regupass" @bind-value="RegisterForms.password" @bind-value:event="oninput" placeholder="Password" minlength="8" required />
        <input type="password" id="regurepass" style="@PasswordErrorStyle" name="regurepass" @bind="RePassword" @bind:event="oninput" placeholder="Re:Password" minlength="8" required />
        @if (!PasswordMatches && RePassword != "") { <span class="error">Passwords doesn't match.</span> }
        <button type="submit" @onclick="DoesPasswordsMatch">Register</button>
    </EditForm>
</div>
@if (RegisterFormStatus != "")
{
    <p><span class="success">@RegisterFormStatus</span></p>
}

@code {
    // Variables
    string RegisterFormStatus = "";

    public string RePassword = "";
    public string PasswordErrorStyle = "";

    private bool PasswordMatches;
    private bool RegisterValidationComplete = false;

    // Login & Register Objects
    LoginForm LoginForms = new LoginForm();
    RegisterForm RegisterForms = new RegisterForm();

    public class LoginForm
    {
        public string uname = "";
        public string upass = "";
    }

    public class RegisterForm
    {
        public string username = "";
        public string password = "";
    }

    // Login & Register Methods
    private void DoesPasswordsMatch()
    {
        if (RegisterForms.password == RePassword)
        {
            PasswordMatches = true;
            PasswordErrorStyle = "";
        }
        else
        {
            PasswordMatches = false;
            PasswordErrorStyle = "border: 1px solid red; color: red;";
        }
    }

    async Task LoginFormMethod()
    {
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Post, "https://localhost:7206/auth/login");
            request.SetBrowserRequestCredentials(BrowserRequestCredentials.Include);
            request.Content = JsonContent.Create(new { Username = LoginForms.uname, Password = LoginForms.upass });

            var response = await http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                nav.NavigateTo("/");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.Error.WriteLine($"Login error: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Login exception: {ex}");
        }
    }
    async Task RegisterFormMethod()
    {
        if (PasswordMatches)
        {
            RegisterValidationComplete = true;
        }
        else
        {
            RegisterValidationComplete = false;
        }

        if (RegisterValidationComplete)
        {
            try
            {
                var request = new HttpRequestMessage(HttpMethod.Post, "https://localhost:7206/auth/register");
                request.SetBrowserRequestCredentials(BrowserRequestCredentials.Include);
                request.Content = JsonContent.Create(new { Username = RegisterForms.username, Password = RegisterForms.password });

                var response = await http.SendAsync(request);
 
                if (response.IsSuccessStatusCode)
                {
                    RegisterFormStatus = "User Successfully Registered";
                    nav.NavigateTo("/login");
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    RegisterFormStatus = $"Registration failed: {errorContent}";
                    Console.Error.WriteLine($"Registration error: {errorContent}");
                }
            }
            catch (Exception ex)
            {
                RegisterFormStatus = $"Error: {ex.Message}";
                Console.Error.WriteLine($"Registration exception: {ex}");
            }
        }
    }
}